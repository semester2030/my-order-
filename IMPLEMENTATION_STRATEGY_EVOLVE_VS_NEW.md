# كيف نحدّث التغييرات على التطبيق الحالي دون مشاكل حرجة؟

## الخلاصة: **تطوّر التطبيقات الحالية — لا تنشئ تطبيقاً جديداً**

أنتم تحتاجون:
1. **تطبيق العميل** (Customer App) — موجود ✅  
2. **الأدمن بانل** (Admin Panel) — موجود ✅  
3. **موقع الويب لتسجيل مقدمي الخدمة** (Vendor Web) — موجود ✅  

**التوصية:** تحديث التطبيقات الثلاثة الحالية (تطبيق العميل، الأدمن بانل، موقع تسجيل المقدمين) بدلاً من إنشاء تطبيق جديد. السبب: نفس الـ Backend، نفس المصادقة، ونفس منطق الأعمال؛ إنشاء تطبيق جديد يضاعف الصيانة ويؤخر الإطلاق دون فائدة.

---

## ١. فحص الوضع الحالي (بعمق)

### ١.١ تطبيق العميل (Customer App — Flutter)

| العنصر | الوضع الحالي | ملاحظة |
|--------|---------------|--------|
| **بعد تسجيل الدخول** | `navigateAfterAuth` → إما `selectAddressMap` أو `feed` | نقطة التغيير: بدلاً من `context.go(RouteNames.feed)` نوجّه إلى **شاشة الأيقونات الأربع** (مثلاً `RouteNames.categories` أو `home`). |
| **الـ Feed** | `FeedScreen` يستدعي `feedNotifier.loadFeed()` بدون فلتر فئة | الـ API يدعم بالفعل `vendorType` في `GetFeedDto`؛ نضيف معلمة **فئة** (مثلاً `category`) ونمرّرها من شاشة الأيقونات. |
| **الـ Bottom Nav** | Feed, Cart, Orders, Payment, Profile | يمكن إبقاؤها؛ أو استبدال "Feed" بـ "اكتشف" والرابط الأول يفتح شاشة الأيقونات الأربع ثم الدخول لـ Feed حسب الفئة. لا حذف لـ Cart/Orders (مفيدة للطبخ المنزلي والطلب اليومي). |
| **الروابط** | `feed`, `vendor-details/:id`, `cart`, `orders`, ... | نضيف route لشاشة الأيقونات (مثلاً `/categories` أو `/home`) وندخل منها إلى Feed بمعلمة فئة (مثلاً `/feed?category=home_cooking` أو `/feed/home-cooking`). |
| **المخاطر** | لو غيّرنا التوجيه فجأة قد "يختفي" Feed للمستخدم الحالي | نستخدم **إعداداً أو feature flag**: إذا "وضع الأيقونات" مفعّل → التوجيه لشاشة الأيقونات؛ وإلا التوجيه لـ Feed كما هو. |

### ١.٢ الـ Backend

| العنصر | الوضع الحالي | ما المطلوب؟ |
|--------|---------------|-------------|
| **Vendor** | حقل `type: VendorType` (fine_dining, premium_casual, gourmet_desserts) | إضافة حقل **فئة مقدم الخدمة** (مثلاً `provider_category` أو توسيع الـ enum): `home_cooking`, `popular_cooking`, `private_events`, `grilling`. يفضّل عمود جديد `provider_category` لعدم كسر الـ type الحالي. |
| **Feed** | `GetFeedDto` فيه `vendorType`؛ `FeedService.getFeed()` يفلتر حسب `vendorType` | إضافة معلمة **category** (أو استخدام نفس الحقل مع قيم الفئات الأربع) وفلترة الـ Vendors حسبها. لو استخدمتم `provider_category` في Vendor فالفلاتر تكون عليه. |
| **تسجيل المقدم (Vendor)** | الـ API يقبل بيانات تسجيل مع `type` (نوع مطعم) | قبول **فئة المقدم** (الطبخ المنزلي، الشعبي، المناسبات الخاصة، الشوي) وحفظها في `provider_category`. |

### ١.٣ موقع تسجيل مقدمي الخدمة (Vendor Web — Next.js)

| العنصر | الوضع الحالي | ما المطلوب؟ |
|--------|---------------|-------------|
| **صفحة التسجيل** | نموذج مع "Restaurant type" (Premium Casual, Fine Dining, ...) | إضافة (أو استبدال) حقل **فئة مقدم الخدمة**: الطبخ المنزلي، الطبخ الشعبي، المناسبات الخاصة، الشوي. إرسال القيمة للـ Backend مع باقي البيانات. |
| **الداشبورد** | Dashboard, Orders, Menu, Staff, Analytics, Settings | يمكن إبقاؤه كما هو؛ لاحقاً إضافة قسم "المناسبات" أو "طلبات المناسبات" إن وُجدت. Orders تبقى (للطلب اليومي من الطبخ المنزلي أو للمناسبات لاحقاً). |

### ١.٤ الأدمن بانل (Admin Panel — Next.js)

| العنصر | الوضع الحالي | ما المطلوب؟ |
|--------|---------------|-------------|
| **قائمة المقدمين (Vendors)** | عرض المطاعم/المقدمين وقبول/رفض | إضافة **فلتر حسب الفئة** (الطبخ المنزلي، الشعبي، المناسبات الخاصة، الشوي) عندما يصبح الحقل موجوداً في الـ API. لا حاجة لتغيير بنيوي. |

---

## ٢. خطة التحديث (مراحل — دون مشاكل حرجة)

### المرحلة ١: Backend — الفئة وفلتر الـ Feed

| الخطوة | الوصف | تجنب المشاكل |
|--------|--------|----------------|
| 1.1 | إضافة عمود `provider_category` إلى جدول `vendors` (قيم: home_cooking, popular_cooking, private_events, grilling) — nullable في البداية | migration منفصل؛ القيم القديمة تبقى null ولا تنكسر. |
| 1.2 | تحديث كيان Vendor وإضافة الحقل؛ تحديث DTO تسجيل المقدم ليقبل `providerCategory` | عدم حذف `type` الحالي؛ التعامل مع الاثنين حتى تستقر الفئات. |
| 1.3 | في GetFeedDto إضافة `category` (اختياري)； في FeedService فلترة Vendors حسب `provider_category` عندما تُمرّر category | عند عدم تمرير category نترك السلوك الحالي (كل المقدمين أو حسب vendorType) لعدم كسر التطبيق الحالي. |

### المرحلة ٢: تطبيق العميل — شاشة الأيقونات الأربع والتوجيه

| الخطوة | الوصف | تجنب المشاكل |
|--------|--------|----------------|
| 2.1 | إضافة route لشاشة "الأيقونات الأربع" (مثلاً `/categories` أو `/home`) وعرض أربع أيقونات: الطبخ المنزلي، الطبخ الشعبي، المناسبات الخاصة، الشوي | شاشة جديدة فقط؛ لا تعديل على FeedScreen أو Cart. |
| 2.2 | عند الضغط على أيقونة: الانتقال إلى Feed مع معلمة الفئة (مثلاً `/feed?category=home_cooking` أو route مثل `/feed/home-cooking` وقراءة الفئة من الـ path) | إعادة استخدام FeedScreen الحالي مع معلمة اختيارية. |
| 2.3 | في FeedNotifier/FeedScreen: عند وجود `category` استدعاء API الـ Feed مع `category`؛ عند غيابها السلوك الحالي (بدون فلتر فئة) | لا كسر للمستخدمين الحاليين إن دخلوا Feed مباشرة. |
| 2.4 | تغيير `navigateAfterAuth`: بدلاً من `context.go(RouteNames.feed)` استخدام `context.go(RouteNames.categories)` (أو اسم الشاشة الجديدة) | يمكن جعل ذلك مشروطاً بـ feature flag أو إعداد من السيرفر لتفعيل/إيقاف "وضع الأيقونات". |
| 2.5 | الـ Bottom Nav: الرابط الأول إما "اكتشف" أو "الرئيسية" ويوجّه إلى شاشة الأيقونات؛ أو يبقى "Feed" ويفتح شاشة الأيقونات. إبقاء Cart و Orders و Profile كما هي | لا حذف لأي عنصر؛ فقط تغيير الوجهة عند الحاجة. |

### المرحلة ٣: موقع تسجيل المقدمين (Vendor Web)

| الخطوة | الوصف | تجنب المشاكل |
|--------|--------|----------------|
| 3.1 | في نموذج التسجيل إضافة حقل **فئة مقدم الخدمة** (الطبخ المنزلي، الطبخ الشعبي، المناسبات الخاصة، الشوي) — اختيار واحد أو أكثر حسب المنتج | إما استبدال "Restaurant type" بالفئات الجديدة أو إضافتها كحقل إضافي وربطها بـ `providerCategory` في الـ API. |
| 3.2 | إرسال `providerCategory` (أو قائمة فئات) مع طلب التسجيل؛ التأكد من أن الـ Backend يحفظها في `provider_category` | التحقق من أن الـ API يقبل الحقل ولا يرفض الطلبات القديمة إن كان الحقل اختيارياً. |

### المرحلة ٤: الأدمن بانل

| الخطوة | الوصف | تجنب المشاكل |
|--------|--------|----------------|
| 4.1 | في صفحة قائمة المقدمين (Vendors) إضافة فلتر حسب **فئة مقدم الخدمة** (الطبخ المنزلي، الشعبي، المناسبات الخاصة، الشوي) | يعتمد على أن الـ API يرجع `provider_category` ويدعم فلترة حسبه (query param). |

---

## ٣. مخاطر حرجة وكيف تتجنبها

| المخاطرة | كيف تتجنبها |
|----------|-------------|
| كسر الـ Feed الحالي | عدم حذف استدعاء Feed بدون معلمة؛ عند غياب `category` يعمل الـ Feed كما هو (كل المقدمين أو حسب vendorType). |
| كسر تسجيل المقدمين القدامى | جعل `provider_category` nullable أو اختيارياً في الـ API؛ القيم القديمة تبقى null. |
| تضارب مع تطبيق قديم (نسخة لم تُحدّث) | الـ API يقبل المعلمات الجديدة دون إلزام؛ التطبيق القديم يستمر بالعمل بدون category. |
| فقدان بيانات | عدم حذف أعمدة أو حقول قديمة في المرحلة الأولى؛ إضافة فقط. |
| تعقيد الـ UI دفعة واحدة | البدء بشاشة أيقونات بسيطة و Feed بفلتر فئة فقط؛ الفلاتر الفرعية (داخل كل فئة) تأتي لاحقاً. |

---

## ٤. ما لا تحتاج فعله

- **لا تنشئ تطبيق عميل جديد** — التطبيق الحالي يتحمل شاشة الأيقونات والـ Feed المُصنّف.  
- **لا تنشئ أدمن بانل جديد** — إضافة فلتر فئة في قائمة المقدمين كافية.  
- **لا تنشئ موقع تسجيل مقدمين جديد** — إضافة حقل الفئة في النموذج الحالي كافية.  
- **لا تحذف Cart أو Orders** — تبقى للطلب اليومي (الطبخ المنزلي) وللمناسبات لاحقاً إن ربطتم الطلبات بها.  

---

## ٥. ترتيب التنفيذ المقترح

1. **Backend:** إضافة `provider_category` + دعم فلتر Feed حسب الفئة + دعم الحقل في تسجيل المقدم.  
2. **تطبيق العميل:** شاشة الأيقونات الأربع + ربطها مع Feed بمعلمة الفئة + تغيير التوجيه بعد الدخول (مع إمكانية feature flag).  
3. **Vendor Web:** حقل فئة مقدم الخدمة في التسجيل وإرساله للـ API.  
4. **الأدمن بانل:** فلتر الفئة في قائمة المقدمين.  

بهذا تُحدّث التغييرات على التطبيق الحالي (تطبيق العميل، الأدمن بانل، موقع تسجيل المقدمين) دون إنشاء تطبيق جديد، مع تقليل احتمال مشاكل حرجة عبر التدرج وعدم حذف السلوك الحالي حتى يستقر الجديد.
