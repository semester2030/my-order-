# الإضافات الحاسمة لإطلاق تطبيق مقدم الخدمة (الـ 10% المصيرية)

**المرجع:** ملاحظات التقييم على الشجرة — دمجها في الهيكل الرسمي والشجرة الكاملة.

---

## رأي الهندسة على الملاحظات

**الخلاصة:** الملاحظات صحيحة ومهمة. الـ 90% الأولى (Clean Architecture، فصل Menu/Services، Videos، Side Orders) كافية للهيكل، لكن بدون الـ 10% التالية التطبيق سيعاني من ترقيع لاحقًا. تم دمج كل النقاط أدناه في الهيكل والشجرة.

---

## ١. Shell / Navigation (وحدة التنقل)

**المشكلة:** وجود "Drawer أو Bottom Nav" في النص دون module واضح يسبب تنقل غير موحد.

**الإضافة:**

| المسار | الملف | الوظيفة |
|--------|--------|---------|
| `modules/shell/presentation/screens/` | `shell_screen.dart` | الشاشة الحاوية بعد تسجيل الدخول: تعرض القائمة الجانبية أو الـ Bottom Nav وتستبدل الجسم حسب المسار. |
| `modules/shell/presentation/widgets/` | `vendor_drawer.dart` | القائمة الجانبية: Dashboard، Orders، Menu، Services، Side Orders (حسب الفئة)، Staff، Analytics، Settings، تسجيل خروج. |
| `modules/shell/presentation/widgets/` | `vendor_bottom_nav.dart` | بديل: شريط سفلي بنفس العناصر (أو مجموعة فرعية منها). |

**النتيجة:** مسار واحد موحد بعد Login → Shell → كل الشاشات الداخلية تفتح داخل الـ Shell.

---

## ٢. Bootstrap / Session (تشغيل التطبيق والجلسة)

**المشكلة:** بدون طبقة تشغيل واضحة: جلب session + profile ثم توجيه (Login / Shell / Pending) يصعب ضمان سلوك موحد عند كل فتح.

**الإضافة:**

| المسار | الملف | الوظيفة |
|--------|--------|---------|
| `core/bootstrap/` | `app_bootstrapper.dart` | عند بدء التطبيق: قراءة التوكن من Secure Storage، إن وُجد استدعاء جلب البروفايل، ثم إرجاع حالة: unauthenticated / pending / rejected / authenticated. |
| `modules/auth/domain/` | (موجود) `vendor_session.dart` | يمتد ليشمل حالة الموافقة إن لزم. |
| `modules/auth/presentation/providers/` | `session_notifier.dart` | يوفّر: هل هناك session، وما حالة الموافقة (pending / rejected / approved). الـ Shell والـ Router يعتمدان عليه. |

**التدفق المقترح:**

```
App Start → Bootstrapper
  → لا توكن؟ → Login
  → توكن + status = pending؟ → Pending Screen
  → توكن + status = rejected؟ → Rejected Screen
  → توكن + status = approved؟ → Shell (Dashboard كأول تبويب)
```

---

## ٣. شاشات الموافقة (Pending / Rejected)

**المشكلة:** نظام الموافقة على مقدمي الخدمة موجود في الباك اند؛ بدون شاشات واضحة للمراجعة والرفض تصبح تجربة المقدم مربكة.

**الإضافة:**

| المسار | الملف | الوظيفة |
|--------|--------|---------|
| `modules/auth/presentation/screens/` | `pending_screen.dart` | "طلبك قيد المراجعة" مع رسالة واضحة وربما رقم تواصل. |
| `modules/auth/presentation/screens/` | `rejected_screen.dart` | "لم تتم الموافقة" مع عرض سبب الرفض (من الباك اند) وزر "تواصل مع الدعم" أو "إعادة التقديم" إن وُجد. |

**المسارات:**  
`/pending` ، `/rejected` (بعد Login عند وجود session لكن الحالة غير معتمدة).

---

## ٤. رفع الصور (Image / Media)

**المشكلة:** الويب يرفع صور وجبات/خدمات؛ الموبايل يحتاج اختيار صورة، ضغط اختياري، رفع مع تقدم.

**الإضافة:**

| المسار | الملف | الوظيفة |
|--------|--------|---------|
| `core/media/` | `image_picker_service.dart` | اختيار صورة من المعرض أو الكاميرا (استخدام image_picker). |
| `core/media/` | `file_uploader.dart` | واجهة موحدة لرفع ملف: مسار محلي، endpoint، رفع مع progress؛ يستخدم من Menu/Services للصور ومن Videos للفيديو إن أردت توحيد الاستدعاء. |

بديل: وضع نفس الملفات تحت `modules/videos/` كـ `media/` (image_picker_service، file_uploader) إذا رغبت بجمع كل الـ media في وحدة واحدة.

---

## ٥. Pagination + Filters (نماذج مشتركة)

**المشكلة:** قوائم الطلبات والوجبات تحتاج page, limit, status، وربما search/filter؛ عدم وجود نموذج مشترك يسبب تكرار وعدم اتساق.

**الإضافة:**

| المسار | الملف | الوظيفة |
|--------|--------|---------|
| `shared/models/` | `paged_result.dart` | نموذج عام: `List<T> items`, `int page`, `int limit`, `int total`, `bool hasMore`. |
| `shared/models/` | `api_meta.dart` | إن كان الباك اند يرجع meta (total, page, totalPages) في غلاف منفصل. |

استخدامها في: orders_repo، menu_repo، services_repo، staff_repo عند استدعاء list مع query params.

---

## ٦. Result / Either (معالجة أخطاء موحدة)

**المشكلة:** الاعتماد على try/catch في كل repo يسبب توزيع معالجة الأخطاء وعدم اتساق.

**الإضافة:**

| المسار | الملف | الوظيفة |
|--------|--------|---------|
| `core/utils/` | `result.dart` | نوع `Result<T, E>` أو `Success<T> | Failure<E>`؛ الـ repos ترجع Result؛ الـ notifiers تتعامل مع Success/Failure بشكل موحد. |

بديل: استخدام حزمة مثل `dartz` أو `fpdart` لـ Either إن فضلت ذلك.

---

## ٧. Localization (التوطين)

**المشكلة:** التطبيق عربي وسعودي؛ إضافة النصوص لاحقًا في كل شاشة مكلف.

**الإضافة:**

| المسار | الملف | الوظيفة |
|--------|--------|---------|
| `core/localization/` | `app_localizations.dart` | واجهة أو كلاس للترجمات (حتى لو خريطة بسيطة مفتاح → نص عربي الآن). |
| `core/localization/` | `strings_ar.dart` | نصوص عربية (مفاتيح + قيم). |

لاحقًا: دمج مع `flutter_localizations` وملفات ARB إن أردت دعم لغات متعددة.

---

## ٨. Feature Flags (أعلام الفئات والميزات)

**المشكلة:** تفعيل/إخفاء ميزات حسب الفئة أو البيئة (جاهز للوجبات، طلبات عند الطلب، الطلبات الجانبية) بدون flags يسبب شروط مبعثرة.

**الإضافة:**

| المسار | الملف | الوظيفة |
|--------|--------|---------|
| `core/config/` | `feature_flags.dart` | ثوابت أو خريطة: مثلاً `enable_ready_meals`, `enable_services_requests`, `enable_side_orders`؛ القيم تُقرأ من env أو من profile (مثل providerCategory). الـ Shell والـ UI يقرؤونها لإظهار/إخفاء عناصر. |

---

## ٩. تحديث العدّ (الشاشات والملفات)

| البند | قبل | بعد |
|--------|-----|-----|
| **عدد الشاشات** | 20 | **22** (+ Pending, Rejected) |
| **Shell** | — | +1 شاشة (Shell) + 2 widgets (Drawer, BottomNav) |
| **Core** | 38 | + bootstrap (1) + media (2) + utils/result (1) + localization (2) + config/feature_flags (1) |
| **Auth** | 18 | + session_notifier + pending_screen + rejected_screen |
| **Shared** | 4 | + paged_result, api_meta |

العدد الإجمالي للملفات يزيد وفقًا لذلك؛ يبقى تقريبيًا لأن .freezed و .g.dart تختلف حسب الاستخدام. **المهم:** وضوح عدد الشاشات (22) وعدد الـ modules ووجود الـ 10% الحاسم في الشجرة.

---

## ١٠. ملخص الإضافات في الشجرة

| # | الإضافة | الموقع في الشجرة |
|---|---------|-------------------|
| 1 | Shell | `modules/shell/` — shell_screen، vendor_drawer، vendor_bottom_nav |
| 2 | Bootstrap + Session | `core/bootstrap/app_bootstrapper.dart`، `auth/.../session_notifier.dart` |
| 3 | Pending / Rejected | `auth/.../screens/pending_screen.dart`، `rejected_screen.dart` |
| 4 | Image / Media | `core/media/image_picker_service.dart`، `file_uploader.dart` |
| 5 | Pagination | `shared/models/paged_result.dart`، `api_meta.dart` |
| 6 | Result | `core/utils/result.dart` |
| 7 | Localization | `core/localization/` |
| 8 | Feature Flags | `core/config/feature_flags.dart` |

---

**بهذا تصبح الشجرة جاهزة للإطلاق من ناحية الهيكل دون ترقيع لاحق في التنقل، الجلسة، الموافقة، رفع الصور، أو القوائم.**
